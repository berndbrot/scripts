#!/bin/bash
# Set up voot as the main server for endbracket.net if eagle goes down
# $Id: checkdns.backup,v 1.7 2006/09/30 04:13:12 kadmos Exp $

###
# FUNCTIONS

# Import the common shell functions.
if test -f "$HOME/bin/functions"
then
    . "$HOME/bin/functions"
else
    echo "${0##/*/}: Cannot find function library, exiting"
    exit 1
fi


###
# CONFIGURATION

# DEFAULTS
# Device name of the internet interface.
interface=ppp0

# Whether to print debug messages to stderr.
debug=

# Read local configuration.
if test -f "$HOME/.checkdns"
then
    . "$HOME/.checkdns"
else
    error "Cannot find configuration file $HOME/.checkdns, exiting"
    exit 1
fi

# Configuration file for ddclient.
conf=$HOME/ddclient.$domain.conf

# Cache file for ddclient.
cache=$HOME/ddclient.$domain.cache

primary_down()
{
    ! silent ping -c 3 $primary >/dev/null
}

if internet_reachable
then
    if primary_down
    then
        notice "Cannot reach primary server $primary, redirecting DNS for $domain to this host"
        run /usr/sbin/ddclient -file "$conf" -cache "$cache"
    else
        debug "Successfully contacted $primary, not changing DNS for $domain"
        # make sure that the first time we notice the primary host is down that
        # ddclient at least checks the ip address
        # if we enter this block multiple times after the primary host goes down,
        # the cache file will tell ddclient not to perform any subsequent update
        if test -f "$cache"
        then
            run rm "$cache"
        fi
    fi
fi
