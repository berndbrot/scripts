#!/bin/sh
# installs UNIX configuration files

basedir="$HOME"
confdir="$basedir"/etc
conftar="$HOME"/conf.tar.gz
destdir="$HOME"
hostname="`hostname | sed -e 's/\..*//'`"

if test ! -e "$confdir"
then
    mkdir "$confdir"
fi
if test ! -d "$confdir"
then
    printf "$confdir is not a directory, exiting...\n" 1>&2
    exit 1
fi

gzip -c -d "$conftar" | tar -x -C "$confdir" -f -
if test $? -ne 0
then
    printf "Error extracting configuration archive\n" 1>&2
    exit 1
fi

make_links()
{
	typeset sourcedir
	typeset destdir
	typeset prefix

	sourcedir="$1"
	destdir="$2"
	prefix="$3"

	#echo "Making links from $sourcedir to $destdir" 1>&2

	for sourcefile in "$sourcedir"/*
	do
		filename=${sourcefile##*/}
		destfile="$destdir"/"$prefix""$filename"
		if test -f "$sourcefile"
		then
			if test $destfile -nt $sourcefile
			then
				ext=`date +%Y%m%d%H%M%S`
				printf "$destfile is newer than $conffile, backing up\n" 1>&2
				mv $destfile $destfile.$ext
			fi
			ln -sf $sourcefile $destfile
		elif test -d "$sourcefile"
		then
			if test ! -d "$destfile"
			then
				mkdir -p "$destfile"
				if test $? -ne 0
				then
					printf "Error creating $destfile, skipping $sourcefile\n" 1>&2
					continue
				fi
			fi
			make_links "$sourcefile" "$destfile" ""
		fi
	done
}

make_links "$confdir" "$destdir" "."

